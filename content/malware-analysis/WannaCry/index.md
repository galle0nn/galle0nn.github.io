---
title: "WannaCry Overview"
date: "2022-12-07"
toc: true
description: "Sample of WannaCry from the *Practical Malware Analysis and Triage* course"
---

Sample of WannaCry obtained from the *Practical Malware Analysis and Triage* course.
****

## Tools used
- [floss](https://github.com/mandiant/flare-floss/releases)
- [PEBear](https://github.com/hasherezade/pe-bear-releases)
- [Cutter](https://github.com/rizinorg/cutter/releases)
- [Wireshark](https://www.wireshark.org/download.html)
- Procmon
- [x64dbg](https://github.com/x64dbg/x64dbg/releases)
- inetsim
****

# Analysis

- sha256:`24D004A104D4D54034DBCFFC2A4B19A11F39008A575AA614EA04703480B1022C`
- Sample was 7zip compressed with the password of *infected*

## Initial Detonation Observations
- Did not have *inetsim* running, no internet connectivity
	- **If *inetsim* was running, nothing appears to happen when malware was detonated**

![popup](<images/2.png>)
![caption](<images/3.png>)

**Main Symptoms**
- Texts, documents, photos and videos have the `.WNCRY` extension after the filename
	- Looks like it copies the files with the `.WNCRY` extension added
		- Original files are gone, are they deleted?
	- Unable to open any of these files, even after trying to change the extension back
		- Files are encrypted
- Countdown timer asking to pay $300 in BTC in order to get the key to decrypt the files
	- If the ransom is not paid after the first timer expires, the price is doubled

****

## Static Analysis
### floss
- Strings of interest:
```
C:\%s\qeriuwjhrf
tasksche.exe
WriteFile
CreateFileA
CreateProcessA
hxxp://www[.]iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea[.]com
c.wnry
InternetCloseHandle
InternetOpenUrlA
InternetOpenA
WININET.dll
```
- Can hypothesize that the malware makes a call to the domain server:  `hxxp://www[.]iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea[.]com`


### PeBear
- 32-bit, x86 architecture
- Opening sample in [PEBear](https://github.com/hasherezade/pe-bear-releases) also shows that *WININET.dll* is present in the imports and corresponds with the *InternetCloseHandle*, *InternetOpenUrlA* and *InternetOpenA* API calls
- First byte has *MZ* which indicates that the sample is a Portable Executable
- Virtual size = 1F8 (504) vs. Size of Raw Data = 200 (512)
	- Not a packed binary

### Cutter
- Looking at `main` method ![caption](<images/18.png>)
- Same domain callback on the string as what was seen in floss output
- `[InternetOpenA]` - Initializes an application's use of WinINet functions, preps to open a handle to a given web resource 
	- Everything was pushed to `eax` for this call except "dwAccessType" 
- `[InternetOpenUrlA]`  - Opens a resource specified by a complete FTP or HTTP URL
	- Going to load in the URL from `[InternetOpenA]` to use with the API call, make a request to that API and whatever returns (yes it worked or no it did not), load that into `eax` as a value (1 or 0) 
	- `esi` argument used for `hInternet` - Handles current internet session. The first callback domain was moved into `esi` 

![caption](<images/23.png>)
1. `eax` is loaded into `edi` where `edi` is tested to see the results of the value from `[InternetOpenUrlA]`
2. Moves `[InternetCloseHandle]` but does not *call* until after `test edi, edi`
3. `jne` expression, jumps to the *right-side* method if `edi` is not equal (if it was not completed)
	1. *right-side (0x004081bc)* : Closes domain handle, pushes `edi`, pops `edi` from stack, pops `esi` from stack
	2. *left-side (0x004081a7)*: Closes domain handle, calls `fcn.00408090` where it starts the service and begins encryption of files

![caption](<images/26.png>)
- `fcn.00408090` leads to other function calls where it begins copying files in the system and creating a new filename with `.WNCRY` extension

****

## Dynamic Analysis

### Wireshark

![caption](<images/12.png>)
- DNS query to the same domain seen from floss and cutter

### Procmon
![caption](<images/13.png>)
![caption](<images/14.png>)
- Constantly sending TCP requests to different IP addresses
	- Attempting to connect to several other hosts on the network to infect
	- **Indicators of a WORM**

![caption](<images/16.png>) ![caption](<images/28.png>)
- `tasksche.exe` was file created along with a suspicious directory
	1. Staging area for the malware, where it unpacks all of its packed resources 
	2. 2nd stage of installation
- A service is created as the exact same name as the directory created in ProgramData
	- **Persistence mechanism**
	- If you restart your computer, WannaCry comes back on and re-encrypts anything added to the host
- Registry keys were also created

### x32dbg
![caption](<images/24.png>)
- The call to determine whether the malware will be activated or not
- Similar to what was seen in the `main` method from Cutter

#### With inetsim
![caption|1000](<images/29.png>)
- `test edi, edi`, `ZF` flag is **0** so it jumps to where the malware is **not activated**

#### Without inetsim
![caption|1000](<images/27.png>)
- `test edi, edi`, `ZF` flag is **1** so a jump did not occur, leading to the activation of the malware with `call ransonware.wannacry.408090`

****

## Conclusion
- In order for the malware to activate, it has to be able to make a call to the domain server: `hxxp://www[.]iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea[.]com`
	- Domain **can't** be active for the malware to activate, if domain **is active**, nothing will happen
		- If *inetsim* was open, it would think that the domain was **active and live**, so the malware will not activate
- Once the malware is activated, it begins copying all files to the same directory and replacing them with a `.WNCRY` extension


## Next Steps
- Analysis on `tasksche.exe`
- Detection signatures


## References
- https://github.com/HuskyHacks/PMAT-labs