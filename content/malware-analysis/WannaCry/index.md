---
title: "WannaCry Overview"
date: "2022-12-07"
toc: true
description: "Sample of WannaCry from the *Practical Malware Analysis and Triage* course"
---

Sample of WannaCry obtained from the *Practical Malware Analysis and Triage* course.
****

## Tools used
- [floss](https://github.com/mandiant/flare-floss/releases)
- [PEBear](https://github.com/hasherezade/pe-bear-releases)
- [Cutter](https://github.com/rizinorg/cutter/releases)
- [Wireshark](https://www.wireshark.org/download.html)
- Procmon
- [x64dbg](https://github.com/x64dbg/x64dbg/releases)
- inetsim
****

# Analysis

- sha256: `24d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c`
- Sample was 7zip compressed with the password of *infected*

## Initial Detonation Observations
- Did not have *inetsim* running, no internet connectivity
	- **If *inetsim* was running, nothing appears to happen when malware was detonated**

![popup](<images/2.png>)
![caption](<images/3.png>)

**Main Symptoms**
- Texts, documents, photos and videos have the `.WNCRY` extension after the filename
	- Looks like it copies the files with the `.WNCRY` extension added
		- Original files are gone, are they deleted?
	- Unable to open any of these files, even after trying to change the extension back
		- Files are encrypted
- Countdown timer asking to pay $300 in BTC in order to get the key to decrypt the files
	- If the ransom is not paid after the first timer expires, the price is doubled

****

## Static Analysis
### floss
- Strings of interest:
```
C:\%s\qeriuwjhrf
tasksche.exe
WriteFile
CreateFileA
CreateProcessA
hxxp://www[.]iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea[.]com
c.wnry
InternetCloseHandle
InternetOpenUrlA
InternetOpenA
WININET.dll
```
- Can hypothesize that the malware makes a call to the domain server:  `hxxp://www[.]iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea[.]com`


### PeBear
- 32-bit, x86 architecture
- Opening sample in [PEBear](https://github.com/hasherezade/pe-bear-releases) also shows that *WININET.dll* is present in the imports and corresponds with the *InternetCloseHandle*, *InternetOpenUrlA* and *InternetOpenA* API calls
- First byte has *MZ* which indicates that the sample is a Portable Executable
- Virtual size = 1F8 (504) vs. Size of Raw Data = 200 (512)
	- Not a packed binary

### Cutter
- Looking at `main` method ![caption](<images/18.png>)
- Same domain callback on the string as what was seen in floss output
- `[InternetOpenA]` - Initializes an application's use of WinINet functions, preps to open a handle to a given web resource 
	- Everything was pushed to `eax` for this call except "dwAccessType" 
- `[InternetOpenUrlA]`  - Opens a resource specified by a complete FTP or HTTP URL
	- Going to load in the URL from `[InternetOpenA]` to use with the API call, make a request to that API and whatever returns (yes it worked or no it did not), load that into `eax` as a value (1 or 0) 
	- `esi` argument used for `hInternet` - Handles current internet session. The first callback domain was moved into `esi` 

![caption](<images/23.png>)
1. `eax` is loaded into `edi` where `edi` is tested to see the results of the value from `[InternetOpenUrlA]`
2. Moves `[InternetCloseHandle]` but does not *call* until after `test edi, edi`
3. `jne` expression, jumps to the *right-side* method if `edi` is not equal (if it was not completed)
	1. *right-side (0x004081bc)* : Closes domain handle, pushes `edi`, pops `edi` from stack, pops `esi` from stack
	2. *left-side (0x004081a7)*: Closes domain handle, calls `fcn.00408090` where it starts the service and begins encryption of files

![caption](<images/26.png>)
- `fcn.00408090` leads to other function calls where it begins copying files in the system and creating a new filename with `.WNCRY` extension

****

## Dynamic Analysis

### Wireshark
![caption](<images/12.png>)
- DNS query to the same domain seen from floss and cutter

### Procmon
![caption](<images/14.png>)
- Constantly sending TCP requests to different IP addresses
	- Attempting to connect to several other hosts on the network to infect
	- **Indicators of a WORM**
![caption](<images/16.png>) ![caption](<images/28.png>)
- Suspicious directory *nsxbrhdekduihd377* was created
	- `@WanaDecryptor@.exe` `tasksche.exe`, `taskdl.exe` and `taskse.exe` executable files within the directory
	1. Staging area for the malware, where it unpacks all of its packed resources 
	2. 2nd stage of installation
- A service was created with the same name as the directory created in ProgramData (*nsxbrhdekduihd377*)
	- **Persistence mechanism**
	- If you restart your computer, WannaCry comes back on and re-encrypts anything added to the host
- Registry keys were also created

### x32dbg
![caption](<images/24.png>)
- The call to determine whether the malware will be activated or not
- Similar to what was seen in the `main` method from Cutter

#### With inetsim
![caption|1000](<images/29.png>)
- `test edi, edi`, `ZF` flag is **0** so it jumps to where the malware is **not activated**

#### Without inetsim
![caption|1000](<images/27.png>)
- `test edi, edi`, `ZF` flag is **1** so a jump did not occur, leading to the activation of the malware with `call ransomware.wannacry.408090`

****

## Conclusion
- In order for the malware to activate, it has to be able to make a call to the domain server: `hxxp://www[.]iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea[.]com`
	- Domain **can't** be active for the malware to activate, if domain **is active**, nothing will happen
		- If *inetsim* was open, it would think that the domain was **active and live**, so the malware will not activate
- Once the malware is activated, it begins copying all files to the same directory and replacing them with a `.WNCRY` extension

****

## Indicators of Compromise

| Type   | Indicator                                                        | Description       |
| ------ |:---------------------------------------------------------------- | ----------------- |
| SHA256 | 24d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c | wannacry.exe      |
| SHA256 | b9c5d4339809e0ad9a00d4d3dd26fdf44a32819a54abf846bb9b560d81391c25 | WanaDecryptor.exe |
| SHA256 | d38716a81c8a9930b8d41e706eeb52ed54a0dbf39e143df3cd67f7bccbd6d159 | tasksche.exe      |
| SHA256 | 2ca2d550e603d74dedda03156023135b38da3630cb014e3d00b1263358c5f00d | taskse.exe        |
| SHA256 | 4a468603fdcb7a2eb5770705898cf9ef37aade532a7964642ecd705a74794b79 | taskdl.exe        |
| URL    | hxxp://www[.]iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea[.]com     | Contacted URL     |

## Detection

### YARA
```c
rule malware_wannacry {
	meta:
		author = "PMAT"
		created = "2022-12-15"
		description = "WannaCry Ransomware"
		hash = "24d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c"

	strings:
		$str_0 = "C:\\%s\\qeriuwjhrf" ascii fullword
		$str_1 = "tasksche.exe" ascii fullword
		$str_2 = "taskdl.exe" ascii fullword
		$str_3 = "www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com" ascii fullword
		$str_4 = "WNcry@2o17" ascii fullword nocase
		$str_5 = "icacls . /grant Everyone:F /T /C /Q" ascii fullword
		$str_6 = "Ooops, your files have been encrypted!" ascii

	condition:
		uint16(0) == 0x5a4d and
		3 of them
}
```


## References
- [Sample](https://github.com/HuskyHacks/PMAT-labs)
- [VirusTotal](https://www.virustotal.com/gui/file/24d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c/detection)
