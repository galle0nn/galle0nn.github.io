<!doctype html><html lang=en><head><title>WannaCry Overview ::
The Shipyard</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Sample of WannaCry obtained from the Practical Malware Analysis and Triage course.
Analysis # sha256:24d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c Sample was 7zip compressed with the password of infected WannaCry # Wannacry is a ransomware malware that was first discovered in May 2017. Having infected thousands of computers around the world, it was described as a highly virulent strain of malware. WannaCry was attributed to a group known as the Lazarus Group, which is believed to be a state-sponsored group based in North Korea."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://galle0nn.github.io/malware-analysis/wannacry/><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://galle0nn.github.io/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://galle0nn.github.io/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://galle0nn.github.io/img/favicon.png><link href=/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="WannaCry Overview"><meta name=twitter:description content="Analysis of the WannaCry ransomware"><meta property="og:title" content="WannaCry Overview"><meta property="og:description" content="Analysis of the WannaCry ransomware"><meta property="og:type" content="article"><meta property="og:url" content="https://galle0nn.github.io/malware-analysis/wannacry/"><meta property="article:section" content="malware-analysis"><meta property="article:published_time" content="2022-12-07T00:00:00+00:00"><meta property="article:modified_time" content="2022-12-07T00:00:00+00:00"><meta property="og:site_name" content="The Shipyard"></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>cd /home</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/malware-analysis>Malware Analysis</a></li><li><a href=/documents>Documents</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/malware-analysis>Malware Analysis</a></li><li><a href=/documents>Documents</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><article class=post><h1 class=post-title>WannaCry Overview</h1><div class=post-meta><time class=post-date>2022-12-07</time></div><div class=post-content><h2>Table of Contents</h2><aside class=table-of-contents><nav id=TableOfContents><ul><li><a href=#wannacry>WannaCry</a></li><li><a href=#initial-detonation-observations>Initial Detonation Observations</a></li><li><a href=#static-analysis>Static Analysis</a><ul><li><a href=#floss>floss</a></li><li><a href=#pebear>PeBear</a></li><li><a href=#cutter>Cutter</a></li></ul></li><li><a href=#dynamic-analysis>Dynamic Analysis</a><ul><li><a href=#wireshark>Wireshark</a></li><li><a href=#endpoint-behavior>Endpoint Behavior</a></li><li><a href=#x32dbg>x32dbg</a></li></ul></li><li><a href=#conclusion>Conclusion</a></li><li><a href=#indicators-of-compromise>Indicators of Compromise</a></li><li><a href=#detection>Detection</a><ul><li><a href=#yara>YARA</a></li></ul></li><li><a href=#references>References</a></li></ul></nav></aside><p>Sample of WannaCry obtained from the <em>Practical Malware Analysis and Triage</em> course.</p><hr><h1 id=analysis>Analysis
<a href=#analysis class=h-anchor aria-hidden=true>#</a></h1><ul><li>sha256:<code>24d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c</code></li><li>Sample was 7zip compressed with the password of <em>infected</em></li></ul><h2 id=wannacry>WannaCry
<a href=#wannacry class=h-anchor aria-hidden=true>#</a></h2><p>Wannacry is a ransomware malware that was first discovered in May 2017. Having infected thousands of computers around the world, it was described as a highly virulent strain of malware. WannaCry was attributed to a group known as the Lazarus Group, which is believed to be a state-sponsored group based in North Korea.</p><hr><h2 id=initial-detonation-observations>Initial Detonation Observations
<a href=#initial-detonation-observations class=h-anchor aria-hidden=true>#</a></h2><ul><li>Texts, documents, photos and videos have the <code>.WNCRY</code> extension after the filename<ul><li><strong>placeholder</strong> (Looks like it copies the files with the <code>.WNCRY</code> extension added, Original files are gone, are they deleted?)</li><li>Unable to open any of these files, even after trying to change the extension back<ul><li>Files are encrypted</li></ul></li></ul></li><li>Countdown timer asking to pay $300 in BTC in order to get the key to decrypt the files<ul><li>If the ransom is not paid after the first timer expires, the price is doubled</li></ul></li><li>It is noted that <em>inetsim</em> was not running at the time of detonation<ul><li>If <em>inetsim</em> was running, nothing appears to happen when malware was detonated</li></ul></li></ul><p><img src=images/2.png alt="figure 1">
<em>Figure 1. Pop-up window after detonation</em></p><p><img src=images/3.png alt="figure 2">
<em>Figure 2. Desktop background after detonation</em></p><hr><h2 id=static-analysis>Static Analysis
<a href=#static-analysis class=h-anchor aria-hidden=true>#</a></h2><h3 id=floss>floss
<a href=#floss class=h-anchor aria-hidden=true>#</a></h3><p>The URL <code>hxxp://www[.]iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea[.]com</code> can be seen in the strings output, can hypothesize that <em>Wannacry</em> may be making a call to the domain server.</p><pre tabindex=0><code>C:\%s\qeriuwjhrf
tasksche.exe
WriteFile
CreateFileA
CreateProcessA
hxxp://www[.]iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea[.]com
c.wnry
InternetCloseHandle
InternetOpenUrlA
InternetOpenA
WININET.dll
</code></pre><p><em>Figure 3. Strings of Interest</em></p><h3 id=pebear>PeBear
<a href=#pebear class=h-anchor aria-hidden=true>#</a></h3><ul><li>32-bit, x86 architecture</li><li><em>WININET.dll</em> is present in the imports and corresponds with the <em>InternetCloseHandle</em>, <em>InternetOpenUrlA</em> and <em>InternetOpenA</em> API calls</li><li>First byte has <em>MZ</em> (4D 5A) which indicates that the sample is a Portable Executable</li><li>Virtual size = 1F8 (504) vs. Size of Raw Data = 200 (512)<ul><li>Not a packed binary</li></ul></li></ul><h3 id=cutter>Cutter
<a href=#cutter class=h-anchor aria-hidden=true>#</a></h3><ul><li>Same domain callback on the string as what was seen in floss output</li><li><code>[InternetOpenA]</code> - Initializes an application&rsquo;s use of WinINet functions, preps to open a handle to a given web resource<ul><li>Everything was pushed to <code>eax</code> for this call except &ldquo;dwAccessType&rdquo;</li></ul></li><li><code>[InternetOpenUrlA]</code> - Opens a resource specified by a complete FTP or HTTP URL<ul><li>Going to load in the URL from <code>[InternetOpenA]</code> to use with the API call, make a request to that API and whatever returns (yes it worked or no it did not), load that into <code>eax</code> as a value (1 or 0)</li><li><code>esi</code> argument used for <code>hInternet</code> - Handles current internet session. The first callback domain was moved into <code>esi</code></li></ul></li></ul><p><img src=images/18.png alt=caption|left>
<em>Figure 4. main method Assembly of WannaCry</em></p><ol><li><code>eax</code> is loaded into <code>edi</code> where <code>edi</code> is tested to see the results of the value from <code>[InternetOpenUrlA]</code></li><li>Moves <code>[InternetCloseHandle]</code> but does not <em>call</em> until after <code>test edi, edi</code></li><li><code>jne</code> expression, jumps to the <em>right-side</em> method if <code>edi</code> is not equal (if it was not completed)<ol><li><em>right-side (0x004081bc)</em> : Closes domain handle, pushes <code>edi</code>, pops <code>edi</code> from stack, pops <code>esi</code> from stack</li><li><em>left-side (0x004081a7)</em>: Closes domain handle, calls <code>fcn.00408090</code> where it starts the service and begins encryption of files</li></ol></li></ol><p><img src=images/23.png alt=caption|left>
<em>Figure 5. Jump expression based on InternetOpenUrlA tested value</em></p><ul><li><code>fcn.00408090</code> leads to other function calls where it begins copying files in the system and creating a new filename with <code>.WNCRY</code> extension</li></ul><p><img src=images/26.png alt=caption|left>
<em>Figure 6. Wannacry ransomware encryption function</em></p><hr><h2 id=dynamic-analysis>Dynamic Analysis
<a href=#dynamic-analysis class=h-anchor aria-hidden=true>#</a></h2><h3 id=wireshark>Wireshark
<a href=#wireshark class=h-anchor aria-hidden=true>#</a></h3><ul><li>DNS query to the same domain seen from floss and cutter</li></ul><p><img src=images/12.png alt=caption|left>
<em>Figure 7. Wireshark DNS query</em></p><h3 id=endpoint-behavior>Endpoint Behavior
<a href=#endpoint-behavior class=h-anchor aria-hidden=true>#</a></h3><ul><li>Constantly sending TCP requests to different IP addresses<ul><li>Attempting to connect to several other hosts on the network to infect</li><li><strong>Indicators of a WORM</strong></li></ul></li></ul><p><img src=images/14.png alt=caption|left>
<em>Figure 8. TCP requests from Procmon</em></p><ul><li>Suspicious directory <em>nsxbrhdekduihd377</em> was created<ul><li><code>@WanaDecryptor@.exe</code> <code>tasksche.exe</code>, <code>taskdl.exe</code> and <code>taskse.exe</code> executable files within the directory</li></ul><ol><li>Staging area for the malware, where it unpacks all of its packed resources</li><li>2nd stage of installation</li></ol></li><li>A service was created with the same name as the directory created in ProgramData (<em>nsxbrhdekduihd377</em>)<ul><li><strong>Persistence mechanism</strong></li><li>If you restart your computer, WannaCry comes back on and re-encrypts anything added to the host</li></ul></li><li>Registry keys were also created</li></ul><p><img src=images/16.png alt=caption|left>
<img src=images/28.png alt=caption|left>
<em>Figure 9. Creation of suspicious directory and files</em></p><h3 id=x32dbg>x32dbg
<a href=#x32dbg class=h-anchor aria-hidden=true>#</a></h3><ul><li>The call to determine whether the malware will be activated or not</li><li>Similar to what was seen in the <code>main</code> method from Cutter</li></ul><p><img src=images/24.png alt=caption|left>
<em>Figure 10. Jump expression in debugger as seen in Cutter</em></p><h4 id=with-inetsim>With inetsim
<a href=#with-inetsim class=h-anchor aria-hidden=true>#</a></h4><ul><li><code>test edi, edi</code>, <code>ZF</code> flag is <strong>0</strong> so it jumps to where the malware is <strong>not activated</strong></li></ul><p><img src=images/29.png alt=caption|1000>
<em>Figure 11. Jump expression if domain callback is successful</em></p><h4 id=without-inetsim>Without inetsim
<a href=#without-inetsim class=h-anchor aria-hidden=true>#</a></h4><ul><li><code>test edi, edi</code>, <code>ZF</code> flag is <strong>1</strong> so a jump did not occur, leading to the activation of the malware with <code>call ransonware.wannacry.408090</code></li></ul><p><img src=images/27.png alt=caption|1000>
<em>Figure 12. Jump expression if domain callback is not successful</em></p><hr><h2 id=conclusion>Conclusion
<a href=#conclusion class=h-anchor aria-hidden=true>#</a></h2><ul><li>In order for the malware to activate, it has to be able to make a call to the domain server: <code>hxxp://www[.]iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea[.]com</code><ul><li>Domain <strong>can&rsquo;t</strong> be active for the malware to activate, if domain <strong>is active</strong>, nothing will happen<ul><li>If <em>inetsim</em> was open, it would think that the domain was <strong>active and live</strong>, so the malware will not activate</li></ul></li></ul></li><li>Once the malware is activated, it begins copying all files to the same directory and replacing them with a <code>.WNCRY</code> extension</li></ul><hr><h2 id=indicators-of-compromise>Indicators of Compromise
<a href=#indicators-of-compromise class=h-anchor aria-hidden=true>#</a></h2><table><thead><tr><th>Type</th><th style=text-align:left>Indicator</th><th>Description</th></tr></thead><tbody><tr><td>SHA256</td><td style=text-align:left>24d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c</td><td>wannacry.exe</td></tr><tr><td>SHA256</td><td style=text-align:left>b9c5d4339809e0ad9a00d4d3dd26fdf44a32819a54abf846bb9b560d81391c25</td><td>WanaDecryptor.exe</td></tr><tr><td>SHA256</td><td style=text-align:left>d38716a81c8a9930b8d41e706eeb52ed54a0dbf39e143df3cd67f7bccbd6d159</td><td>tasksche.exe</td></tr><tr><td>SHA256</td><td style=text-align:left>2ca2d550e603d74dedda03156023135b38da3630cb014e3d00b1263358c5f00d</td><td>taskse.exe</td></tr><tr><td>SHA256</td><td style=text-align:left>4a468603fdcb7a2eb5770705898cf9ef37aade532a7964642ecd705a74794b79</td><td>taskdl.exe</td></tr><tr><td>URL</td><td style=text-align:left>hxxp://www[.]iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea[.]com</td><td>Callback Domain</td></tr></tbody></table><h2 id=detection>Detection
<a href=#detection class=h-anchor aria-hidden=true>#</a></h2><h3 id=yara>YARA
<a href=#yara class=h-anchor aria-hidden=true>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>rule malware_wannacry {
</span></span><span style=display:flex><span>	meta:
</span></span><span style=display:flex><span>		author <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;galle0n&#34;</span>
</span></span><span style=display:flex><span>		created <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;2022-12-15&#34;</span>
</span></span><span style=display:flex><span>		description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;WannaCry Ransomware&#34;</span>
</span></span><span style=display:flex><span>		hash <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;24d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	strings:
</span></span><span style=display:flex><span>		<span style=color:#960050;background-color:#1e0010>$</span>str_0 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;C:</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>%s</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>qeriuwjhrf&#34;</span> ascii fullword
</span></span><span style=display:flex><span>		<span style=color:#960050;background-color:#1e0010>$</span>str_1 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;tasksche.exe&#34;</span> ascii fullword
</span></span><span style=display:flex><span>		<span style=color:#960050;background-color:#1e0010>$</span>str_2 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;taskdl.exe&#34;</span> ascii fullword
</span></span><span style=display:flex><span>		<span style=color:#960050;background-color:#1e0010>$</span>str_3 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;www.iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea.com&#34;</span> ascii fullword
</span></span><span style=display:flex><span>		<span style=color:#960050;background-color:#1e0010>$</span>str_4 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;WNcry@2o17&#34;</span> ascii fullword nocase
</span></span><span style=display:flex><span>		<span style=color:#960050;background-color:#1e0010>$</span>str_5 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;icacls . /grant Everyone:F /T /C /Q&#34;</span> ascii fullword
</span></span><span style=display:flex><span>		<span style=color:#960050;background-color:#1e0010>$</span>str_6 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Ooops, your files have been encrypted!&#34;</span> ascii
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	condition:
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>uint16</span>(<span style=color:#ae81ff>0</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0x5a4d</span> and
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>3</span> of them
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=references>References
<a href=#references class=h-anchor aria-hidden=true>#</a></h2><ul><li><a href=https://github.com/HuskyHacks/PMAT-labs>Sample</a></li><li><a href=https://www.virustotal.com/gui/file/24d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c/detection>VirusTotal</a></li></ul></div></article></div><footer class=footer><div>&nbsp; <a href=https://twitter.com/_galle0n target=_blank rel=noopener title=Twitter><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a>&nbsp;&nbsp; <a href=https://github.com/galle0nn target=_blank rel=noopener title=Github><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a>&nbsp;&nbsp; <a href=mailto:galle0nn@protonmail.com target=_blank rel=noopener title=Email><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a>&nbsp;</div><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>cd /home</span>
<span class=logo__cursor></span></a><div class=copyright><span>©2022 - 2023 galle0n</span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>