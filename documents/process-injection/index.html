<!doctype html><html lang=en><head><title>Process Injection ::
The Shipyard</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Process Injection # A technique often used by malware authors to avoid static detection of their code Injects malicious code into a trusted running process which will then execute said code (payload) Steps for process injection: # Malware obtains a handle to the target process, there are two ways to do this: Malware may obtain this by creating a new process Commonly used API is CreateProcess and its variants Older form of CreateProcess is WinExec for Windows 16-bit compatibility Malware may search for a process that is already running and open it to get the handle Needs a combination of different API functions like: CreateToolhelp32Snapshot, Process32First, OpenProcess and others listed in the image below In both creating or getting a process handle, the process may be suspended to prepare it for injection Malware selects a certain type of data to be injected Section, Process, Code, DLL Depending on the type of injected data, there are different ways to transfer it Data is transferred to the target process Section Transfers only a section of the process NtUnmapViewOfSection API function that carves out a certain section of the process The virtual address space for this section is no longer reserved and can be used for something else NtCreateSection and NtMapViewOfSection API function that creates the new section with the injected data and sets access rights so that the section can be executed Process Similar to Section except transfers the whole process image Code Transfers pieces of code VirtualAllocEx Do not need to carve out section of the memory(NtUnMapViewOfSection), just places pieces of code in memory and uses that instead Used to allocate space in an external process’s memory WriteProcessMemory Used to write data to the allocated space The injected code is executed Section SetThreadContext Tells the system to execute the injected code ResumeThread Resumes the target process that was suspended in the beginning Refer to the table below for commonly used Windows API functions for process injection Figure 1."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://galle0nn.github.io/documents/process-injection/><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://galle0nn.github.io/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://galle0nn.github.io/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://galle0nn.github.io/img/favicon.png><link href=/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="Process Injection"><meta name=twitter:description content="Understanding process injection and API calls to look for during malware analysis"><meta property="og:title" content="Process Injection"><meta property="og:description" content="Understanding process injection and API calls to look for during malware analysis"><meta property="og:type" content="article"><meta property="og:url" content="https://galle0nn.github.io/documents/process-injection/"><meta property="article:section" content="documents"><meta property="article:published_time" content="2023-01-05T00:00:00+00:00"><meta property="article:modified_time" content="2023-01-05T00:00:00+00:00"><meta property="og:site_name" content="The Shipyard"></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>cd /home</span>
<span class=logo__cursor></span></a>
<span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/malware-analysis>Malware Analysis</a></li><li><a href=/documents>Documents</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/malware-analysis>Malware Analysis</a></li><li><a href=/documents>Documents</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><article class=post><h1 class=post-title>Process Injection</h1><div class=post-meta><time class=post-date>2023-01-05</time></div><div class=post-content><h1 id=process-injection>Process Injection
<a href=#process-injection class=h-anchor aria-hidden=true>#</a></h1><ul><li>A technique often used by malware authors to avoid static detection of their code</li><li>Injects malicious code into a trusted running process which will then execute said code (payload)</li></ul><h2 id=steps-for-process-injection><strong>Steps for process injection:</strong>
<a href=#steps-for-process-injection class=h-anchor aria-hidden=true>#</a></h2><ol><li>Malware obtains a handle to the target process, there are two ways to do this:<ol><li>Malware may obtain this by creating a new process<ul><li>Commonly used API is <code>CreateProcess</code> and its variants</li><li>Older form of <code>CreateProcess</code> is <code>WinExec</code> for Windows 16-bit compatibility</li></ul></li><li>Malware may search for a process that is already running and open it to get the handle<ul><li>Needs a combination of different API functions like: <code>CreateToolhelp32Snapshot</code>, <code>Process32First</code>, <code>OpenProcess</code> and others listed in the image below</li></ul></li></ol><ul><li>In both creating or getting a process handle, the process may be suspended to prepare it for injection</li></ul></li><li>Malware selects a certain type of data to be injected<ul><li><strong>Section, Process, Code, DLL</strong></li><li>Depending on the type of injected data, there are different ways to transfer it</li></ul></li><li>Data is transferred to the target process<ul><li><strong>Section</strong><ul><li>Transfers only a section of the process</li></ul><ol><li><code>NtUnmapViewOfSection</code><ul><li>API function that carves out a certain section of the process</li><li>The virtual address space for this section is no longer reserved and can be used for something else</li></ul></li><li><code>NtCreateSection</code> and <code>NtMapViewOfSection</code><ul><li>API function that creates the new section with the injected data and sets access rights so that the section can be executed</li></ul></li></ol></li><li><strong>Process</strong><ul><li>Similar to <em>Section</em> except transfers the whole process image</li></ul></li><li><strong>Code</strong><ul><li>Transfers pieces of code</li></ul><ol><li><code>VirtualAllocEx</code><ul><li>Do not need to carve out section of the memory(<code>NtUnMapViewOfSection</code>), just places pieces of code in memory and uses that instead</li><li>Used to allocate space in an external process’s memory</li></ul></li><li><code>WriteProcessMemory</code><ul><li>Used to write data to the allocated space</li></ul></li></ol></li></ul></li><li>The injected code is executed<ul><li><strong>Section</strong><ol><li><code>SetThreadContext</code><ul><li>Tells the system to execute the injected code</li></ul></li><li><code>ResumeThread</code><ul><li>Resumes the target process that was suspended in the beginning</li></ul></li></ol></li></ul></li></ol><ul><li>Refer to the table below for commonly used Windows API functions for process injection</li></ul><p><img src=images/1.png alt="process injection">
Figure 1. Table for Process Injection techniques and commonly used API functions</p></div></article></div><footer class=footer><div>&nbsp; <a href=https://twitter.com/_galle0n target=_blank rel=noopener title=Twitter><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a>&nbsp;&nbsp; <a href=https://github.com/galle0nn target=_blank rel=noopener title=Github><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a>&nbsp;&nbsp; <a href=mailto:galle0nn@protonmail.com target=_blank rel=noopener title=Email><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a>&nbsp;</div><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>cd /home</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2023 galle0n · Powered by the
<a href=https://github.com/panr/hugo-theme-hello-friend target=_blank rel=noopener>Hello Friend</a> theme for <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>